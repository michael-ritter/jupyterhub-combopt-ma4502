



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/baseline-build-24px.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.3.0">
    
    
      
        <title>GitLab OAuth - JupyterHub-Deployment-CombOpt</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#c0ca33">
      
    
    
      <script src="../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../static/css/toc.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="lime" data-md-color-accent="light-blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#gitlab-authentication" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="JupyterHub-Deployment-CombOpt" class="md-header-nav__button md-logo">
          
            <i class="md-icon">build</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                JupyterHub-Deployment-CombOpt
              </span>
              <span class="md-header-nav__topic">
                GitLab OAuth
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/michael-ritter/jupyterhub-combopt-ma4502/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="JupyterHub-Deployment-CombOpt" class="md-nav__button md-logo">
      
        <i class="md-icon">build</i>
      
    </a>
    JupyterHub-Deployment-CombOpt
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/michael-ritter/jupyterhub-combopt-ma4502/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../what_is_jupyterhub/" title="What is JupyterHub?" class="md-nav__link">
      What is JupyterHub?
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../setup_and_tools/" title="Set Up and Tools" class="md-nav__link">
      Set Up and Tools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ssh_keys/" title="SSH Keys" class="md-nav__link">
      SSH Keys
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../server_setup/" title="Server Setup" class="md-nav__link">
      Server Setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../install_jupyterhub/" title="Install JupyterHub" class="md-nav__link">
      Install JupyterHub
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nginx_install/" title="Install Nginx" class="md-nav__link">
      Install Nginx
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ssl_certificates/" title="SSL Certificates" class="md-nav__link">
      SSL Certificates
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cookie_secret_proxy_auth_token/" title="Cookie Secret and Proxy Auth Token" class="md-nav__link">
      Cookie Secret and Proxy Auth Token
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nginx_config/" title="Nginx Configuration" class="md-nav__link">
      Nginx Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../jupyterhub_config/" title="JupyterHub Configuration" class="md-nav__link">
      JupyterHub Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../systemd/" title="System Service" class="md-nav__link">
      System Service
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../add_users/" title="Add Users" class="md-nav__link">
      Add Users
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../imprint_privacy/" title="Add Imprint and Privacy Statement" class="md-nav__link">
      Add Imprint and Privacy Statement
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        GitLab OAuth
      </label>
    
    <a href="./" title="GitLab OAuth" class="md-nav__link md-nav__link--active">
      GitLab OAuth
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Page Contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gitlab-oauth-instance" title="Gitlab OAuth Instance" class="md-nav__link">
    Gitlab OAuth Instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-the-json-file-to-gitignore" title="Add the json file to .gitignore" class="md-nav__link">
    Add the json file to .gitignore
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#move-the-json-file-to-the-server" title="Move the json file to the server" class="md-nav__link">
    Move the json file to the server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modify-jupyterhub_configpy" title="Modify jupyterhub_config.py" class="md-nav__link">
    Modify jupyterhub_config.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-gitlab_host" title="Set GITLAB_HOST" class="md-nav__link">
    Set GITLAB_HOST
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-oauthenticator-restart-jupyterhub-and-login" title="Install oauthenticator, restart JupyterHub and login" class="md-nav__link">
    Install oauthenticator, restart JupyterHub and login
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-in-with-a-google-username-and-password" title="Log in with a Google username and password" class="md-nav__link">
    Log in with a Google username and password
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" title="Next Steps" class="md-nav__link">
    Next Steps
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../assignments_on_github/" title="Assignments on GitHub" class="md-nav__link">
      Assignments on GitHub
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nbgitpuller_plugin/" title="nbgitpuller Plugin" class="md-nav__link">
      nbgitpuller Plugin
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../extra_configuration/" title="Extra Configuration" class="md-nav__link">
      Extra Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../periodic_maintenance/" title="Periodic Maintenance" class="md-nav__link">
      Periodic Maintenance
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../shutdown/" title="Shutdown" class="md-nav__link">
      Shutdown
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-21" type="checkbox" id="nav-21">
    
    <label class="md-nav__link" for="nav-21">
      Optional Extras
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-21">
        Optional Extras
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../jupyterlab_default_interface/" title="JupyterLab Default Interface" class="md-nav__link">
      JupyterLab Default Interface
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gurobi/" title="Gurobi Installation" class="md-nav__link">
      Gurobi Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../draw_dot_IO_extension/" title="Draw.IO extension" class="md-nav__link">
      Draw.IO extension
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../github_extension/" title="GitHub Extension for JupyterLab" class="md-nav__link">
      GitHub Extension for JupyterLab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../building_docs/" title="Building the Docs" class="md-nav__link">
      Building the Docs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../useful_commands/" title="Useful Commands" class="md-nav__link">
      Useful Commands
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Page Contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gitlab-oauth-instance" title="Gitlab OAuth Instance" class="md-nav__link">
    Gitlab OAuth Instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-the-json-file-to-gitignore" title="Add the json file to .gitignore" class="md-nav__link">
    Add the json file to .gitignore
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#move-the-json-file-to-the-server" title="Move the json file to the server" class="md-nav__link">
    Move the json file to the server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modify-jupyterhub_configpy" title="Modify jupyterhub_config.py" class="md-nav__link">
    Modify jupyterhub_config.py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-gitlab_host" title="Set GITLAB_HOST" class="md-nav__link">
    Set GITLAB_HOST
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-oauthenticator-restart-jupyterhub-and-login" title="Install oauthenticator, restart JupyterHub and login" class="md-nav__link">
    Install oauthenticator, restart JupyterHub and login
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-in-with-a-google-username-and-password" title="Log in with a Google username and password" class="md-nav__link">
    Log in with a Google username and password
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" title="Next Steps" class="md-nav__link">
    Next Steps
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/michael-ritter/jupyterhub-combopt-ma4502/edit/master/docs/gitlab_oauth.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="gitlab-authentication">Gitlab Authentication</h1>
<p>Now that the JupyterHub deployment works and we have two users set up on the server, we are going to get into the weeds of getting the Gitlab authenticator to work. </p>
<p>Why Gitlab authenticator instead of just setting up users one by one at the command line? LRZ provides Gitlab for both staff and students and binds the accounts to the TUMonline accounts. Instead of emailing students individual user names and passwords (and having students remember another set of usernames and passwords), students could log into JuypterHub using the same login that they use to access their gitlab repositories and TUMonline information. It's just going to take a bit of work to get there.</p>
<div class="toc">
<ul>
<li><a href="#gitlab-authentication">Gitlab Authentication</a><ul>
<li><a href="#gitlab-oauth-instance">Gitlab OAuth Instance</a></li>
<li><a href="#add-the-json-file-to-gitignore">Add the json file to .gitignore</a></li>
<li><a href="#move-the-json-file-to-the-server">Move the json file to the server</a></li>
<li><a href="#modify-jupyterhub_configpy">Modify jupyterhub_config.py</a></li>
<li><a href="#set-gitlab_host">Set GITLAB_HOST</a></li>
<li><a href="#install-oauthenticator-restart-jupyterhub-and-login">Install oauthenticator, restart JupyterHub and login</a></li>
<li><a href="#log-in-with-a-google-username-and-password">Log in with a Google username and password</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="gitlab-oauth-instance">Gitlab OAuth Instance</h2>
<p>To allow students to use Gitlab usernames and passwords to log into JupyterHub, the first thing we need to do is set up a Gitlab OAuth instance. </p>
<p>To obtain the Gitlab OAuth credentials, we need to log into Gitlab <a href="https://gitlab.lrz.de/profile/applications">https://gitlab.lrz.de/profile/applications</a> and select [User Settings], then [Applications] on the menu.</p>
<p>Create a new application using <code>JupyterLab</code> as the  name and <code>https://m09vm14.ma.tum.de/hub/oauth_callback</code> as the callback URL. Add <strong>all</strong> scopes (otherwise, you will just get an error later).</p>
<p>After creating a new set of OAuth credentials, note the:</p>
<ul>
<li>application ID</li>
<li>secret</li>
</ul>
<p>The client ID and client secret strings will be included in our revised JupyterHub configuration.</p>
<p>To make things a little easier, we will commit this information to a separate json file where we then pull out the information. Create a json file that looks like this:</p>
<div class="codehilite"><pre><span></span>{&quot;web&quot;:
    {
        &quot;application_id&quot;:&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,
        &quot;secret&quot;:&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;,
        &quot;redirect_uris&quot;:[&quot;https://m09vm14.ma.tum.de/hub/oauth_callback&quot;]
    }
 }
</pre></div>


<p>Set the application ID and the client secret accordingly. </p>
<p>On a local computer, rename the json file to <code>gitlab_oauth_credentials.json</code>. We can use Python and the <code>json</code> module from the Standard Library to pull out the <code>"application_id"</code> and <code>"client_secret"</code> from the json file. Make sure the json file is in the same directory on your local computer where the Python code is run.</p>
<p>Try the following Python code on your local computer:</p>
<div class="codehilite"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;gitlab_oauth_credentials.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">gitlab_oauth</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">gitlab_oauth</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">][</span><span class="s1">&#39;application_id&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gitlab_oauth</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">][</span><span class="s1">&#39;secret&#39;</span><span class="p">])</span>
</pre></div>


<p>The output will be the <code>'application_id'</code> and <code>'secret'</code> from the json file.</p>
<h2 id="add-the-json-file-to-gitignore">Add the json file to .gitignore</h2>
<p>Now we need to move the <code>gitlab_oauth_credentials.json</code> to the sever, but before we do: <strong>MAKE SURE TO ADD THE FILE TO .gitignore !!! WE DON'T WANT PRIVATE CREDENTIALS STORED ON GITHUB !!!</strong>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Important!</strong> Do not save private credentials in a public GitHub repository! Keep your credentials private!</p>
</div>
<p>In <code>.gitignore</code> on my local machine, I added the following lines at the end. Note that locally this file is saved at <code>projectroot/etc/jupyterhub/google_oauth_credentials.json</code></p>
<div class="codehilite"><pre><span></span># .gitignore

...

## Config files

/etc/jupyterhub/config.json
/etc/jupyterhub/google_oauth_credentials.json

...
</pre></div>


<h2 id="move-the-json-file-to-the-server">Move the json file to the server</h2>
<p>Now move the json file over to the server and save it in the <code>/etc/jupyterhub/</code> directory. I used <code>scp</code> to move the json file over to the server, but you can also use <code>vim</code> on the server and just copy-paste.</p>
<p>After the json file is saved on the server, the contents of <code>/etc/jupyterhub</code> on the server should be:</p>
<div class="codehilite"><pre><span></span>/etc/jupyterhub/
├── gitlab_oauth_credentials.json
└── jupyterhub_config.py
</pre></div>


<h2 id="modify-jupyterhub_configpy">Modify jupyterhub_config.py</h2>
<p>Once we get our Gitlab OAuth credentials, we need to edit <code>jupyterhub_conf.py</code> again. Note your Gitlab OAuth credentials are replaced by the credentials from the <code>gitlab_oauth_credentials.json</code> file.</p>
<div class="codehilite"><pre><span></span><span class="c1"># Configuration file for jupyterhub.</span>

<span class="c1"># /etc/jupyterhub/jupyterhub_config.py</span>

<span class="c1"># used to read the json gitlab oauth config file</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">oauthenticator.gitlab</span> <span class="kn">import</span> <span class="n">LocalGitLabOAuthenticator</span>

<span class="c1"># PAM Authenticator</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">c</span><span class="o">.</span><span class="n">Spawner</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;/srv/jupyterhub/venv/bin/jupyterhub-singleuser&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">Spawner</span><span class="o">.</span><span class="n">default_url</span> <span class="o">=</span> <span class="s1">&#39;/lab&#39;</span>

<span class="c1"># Cookie Secret Files</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">cookie_secret_file</span> <span class="o">=</span> <span class="s1">&#39;/srv/jupyterhub/jupyterhub_cookie_secret&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">ConfigurableHTTPProxy</span><span class="o">.</span><span class="n">auth_token</span> <span class="o">=</span> <span class="s1">&#39;/srv/jupyterhub/proxy_auth_token&#39;</span>

<span class="c1"># Users</span>
<span class="c1"># c.Authenticator.whitelist = {&#39;ritter&#39;}</span>
<span class="c1"># c.Authenticator.admin_users = {&#39;ritter&#39;}</span>

<span class="c1"># sets a custom html template at the login screen.</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">template_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/srv/jupyterhub/custom-templates/&#39;</span><span class="p">]</span>

<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">authenticator_class</span> <span class="o">=</span> <span class="n">LocalGitLabOAuthenticator</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/jupyterhub/gitlab_oauth_credentials.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">gitlab_oauth</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGitLabOAuthenticator</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">gitlab_oauth</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">][</span><span class="s1">&#39;application_id&#39;</span><span class="p">]</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitLabOAuthenticator</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="n">gitlab_oauth</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">][</span><span class="s1">&#39;secret&#39;</span><span class="p">]</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGitLabOAuthenticator</span><span class="o">.</span><span class="n">oauth_callback_url</span> <span class="o">=</span> <span class="s1">&#39;https://m09vm14.ma.tum.de/hub/oauth_callback&#39;</span> <span class="c1"># replace with your domain</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitLabOAuthenticator</span><span class="o">.</span><span class="n">create_system_users</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">add_user_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;adduser&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--gecos&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;--disabled-password&#39;</span><span class="p">,</span> <span class="s1">&#39;--force-badname&#39;</span><span class="p">]</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitLabOAuthenticator</span><span class="o">.</span><span class="n">hosted_domain</span> <span class="o">=</span> <span class="s1">&#39;ma.tum.de&#39;</span>   <span class="c1"># replace with your domain</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitLabOAuthenticator</span><span class="o">.</span><span class="n">login_service</span> <span class="o">=</span> <span class="s1">&#39;Technische Universität München&#39;</span>  <span class="c1"># replace with your &#39;College Name&#39;</span>

<span class="c1"># Users</span>
<span class="c1">#c.Authenticator.whitelist = {&#39;ritter&#39;,&#39;viviana&#39;}</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">admin_users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ritter&#39;</span><span class="p">,</span><span class="s1">&#39;michael.ritter&#39;</span><span class="p">}</span>
</pre></div>


<p>This little line:</p>
<div class="codehilite"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">add_user_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;adduser&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--gecos&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;--disabled-password&#39;</span><span class="p">,</span> <span class="s1">&#39;--force-badname&#39;</span><span class="p">]</span>
</pre></div>


<p>was a real gottacha. Our usernames are often in the form:</p>
<p><code>firstname.lastname</code></p>
<p>When a student logs in, JupyterHub tries to create a new Linux user with a dot <code>.</code> in their username. Usernames with <code>.</code> do not work on Linux. I tried to create a new Linux user with a dot in their username, and the terminal asked me to use the <code>--force-badname</code> flag. So <code>--force-badname</code> is what we'll add to the <code>c.Authenticator.add_user_cmd</code> list. Otherwise, users (students) will be able to authenticate with GitLab, but they won't get a new user account on the server, and they won't be able to run notebooks or Python code.</p>
<h2 id="set-gitlab_host">Set <code>GITLAB_HOST</code></h2>
<p>Open the file <code>/etc/systemd/system/jupyterhub.service</code>. In the section <code>[Service]</code> add the following line :</p>
<div class="codehilite"><pre><span></span>Environment=&quot;GITLAB_HOST=https://gitlab.lrz.de&quot;
</pre></div>


<h2 id="install-oauthenticator-restart-jupyterhub-and-login">Install oauthenticator, restart JupyterHub and login</h2>
<p>Before we can restart JupyterHub and try our Google OAuth configuration out, we need to install the Python package <code>oauthenticator</code> into the virtual environment that runs JupyterHub. Log onto the server, activate the virtual environment by changing into the directory  and then issuing the commands:</p>
<div class="codehilite"><pre><span></span># cd /srv/jupyterhub
# source venv/bin/activate
pip install oauthenticator

# python

&gt;&gt;&gt; import oauthenticator
&gt;&gt;&gt; oauthenticator.__version__
&#39;0.8.2&#39;
&gt;&gt;&gt; exit()
</pre></div>


<p>Restart the virtual machine and JupyterHub and browse to the web address attached to the server.</p>
<div class="codehilite"><pre><span></span>$ sudo reboot
</pre></div>


<p>You should see <strong>Active</strong> in the status screen. If not, there is some trouble shooting to do. Use [Ctrl]+[c] to exit the status screen.</p>
<div class="codehilite"><pre><span></span>● jupyterhub.service - JupyterHub
   Loaded: loaded (/etc/systemd/system/jupyterhub.service; disabled; vendor preset: enabled)
   Active: active (running) since Fri 2019-02-08 18:42:23 UTC; 6s ago
 Main PID: 9178 (jupyterhub)
    Tasks: 8 (limit: 1152)
</pre></div>


<h2 id="log-in-with-a-google-username-and-password">Log in with a Google username and password</h2>
<p>If JupyterHub is running OK and there were no errors after the revisions to the <code>jupyterhub_config.py</code> file. Open a web browser and try to Log in.</p>
<p>The login window should now look something like:</p>
<p><img alt="Sign in with Google" src="../images/sign_in_with_google.png" /></p>
<p>We can log in with our Google user name and password (college username and password). </p>
<p>Pretty sweet!</p>
<p>Note the Jupyter notebook file browser is empty after we log on. A new user was created by JupyterHub when we logged in. This new user's home directory is empty.</p>
<p><img alt="Jupyter notebook file browser empty" src="../images/nb_notebook_list_empty.png" /></p>
<p>If you added your college username was added to the <code>c.Authenticator.admin_users = { }</code> set in <code>jupyterhub_config.py</code>, you will be able to see an [Admin] tab when you click [Control Panel] in the Jupyter notebook file browser. If you click [Admin], you should see three users in the user list.</p>
<p><img alt="Jupyter Notebook admin three users" src="../images/nb_admin_three_users.png" /></p>
<p>You can shut down the you college username's notebook server and logout (or play around with some notebooks).</p>
<p>After we log in using our college username and password, we can see if JupyterHub created a new user (with our college username) on the server. The command below produces a long list of users. This long list contains the non-root sudo user <code>peter</code> and the Google authenticated user (college username).</p>
<div class="codehilite"><pre><span></span>$ awk -F&#39;:&#39; &#39;{ print $1}&#39; /etc/passwd
....
uuidd
dnsmasq
landscape
sshd
pollinate
peter
gabby
peter.kazarinoff
</pre></div>


<p><br></p>
<h2 id="summary">Summary</h2>
<p>This was a big section and we got a lot accomplished. At the end of it, we have a running JupyterHub server that allows students and faculty to log into JupyterHub using their college useranmes and passwords. We accomplished this in a couple steps:</p>
<ul>
<li>Create a Google OAuth instance in the Google Developer's console. Download and save the json file that stores the client ID and client secret.</li>
<li>Figure out how to pull the client ID and secret out of the json file using Python's json module from the Standard Library.</li>
<li>Add the json file to .gitignore so that our private client ID and private client secret are not made public.</li>
<li>Move the json file over to the server with FileZilla.</li>
<li>Modify the <code>jupyterhub_config.py</code> file. Add Google authentication to our JupyterHub configuration.</li>
<li>On the server, <code>pip</code> install <strong>oauthenticator</strong> into the virtual environment that runs JupyterHub.</li>
<li>Restart JupyterHub and login with a Google username and password.</li>
<li>Use the JuputerHub admin and the terminal to see the new user JupyterHub added to our server</li>
</ul>
<h2 id="next-steps">Next Steps</h2>
<p>The next step is to make the login screen look like our college login screen. Right now, students see a orange button on the login screen. Next, we'll mess around with some templates, html and css to get our JupyterHub login screen to look a lot more like the college login screen.</p>
<p><br></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../imprint_privacy/" title="Add Imprint and Privacy Statement" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Add Imprint and Privacy Statement
              </span>
            </div>
          </a>
        
        
          <a href="../assignments_on_github/" title="Assignments on GitHub" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Assignments on GitHub
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 Peter D. Kazarinoff, Michael Ritter
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>